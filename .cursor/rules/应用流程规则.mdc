---
description: 
globs: 
alwaysApply: true
---
# 软件版本系统工作流程文档

## 1. 应用流程概述

### 1.1 流程总览
本系统采用前后端分离架构，主要业务流程包括：
- 应用生命周期管理（创建-版本发布-维护）
- 会员权限配置与验证
- API服务调用与安全控制
- 系统安全审计与防护

### 1.2 角色与流程
| 角色 | 核心流程 | 关键操作 |
|------|----------|----------|
| 系统管理员 | 应用管理、安全配置 | 应用CRUD、版本发布、系统监控 |
| 运营人员 | 会员管理 | 权限配置、等级管理 |
| 客户端开发者 | API调用 | 版本查询、会员数据获取 |

## 2. 核心业务流程

### 2.1 应用管理流程
```mermaid
graph TD
    A[管理员登录] --> B[进入应用管理]
    B --> C{操作类型}
    C -->|新增应用| D[填写表单]
    D --> E[系统验证]
    E -->|成功| F[写入DB+更新缓存]
    E -->|失败| G[返回错误提示]
    C -->|版本发布| H[选择应用]
    H --> I[填写版本信息]
    I --> J[自动生成HTML预览]
    J --> K[双重存储DB+ES]
```

**关键节点说明：**
1. 表单验证：实时校验名称长度和描述格式
2. 版本发布：自动校验semver格式，生成MD→HTML转换
3. 删除防护：检查关联版本记录存在性

### 2.2 会员权限配置流程
```mermaid
graph TD
    A[打开权限编辑器] --> B[编辑JSON]
    B --> C{实时验证}
    C -->|有效| D[启用保存按钮]
    C -->|无效| E[显示错误标记]
    D --> F[提交保存]
    F --> G[生成备份快照]
    G --> H[同步Redis权限缓存]
```

**交互细节：**
- JSON编辑器提供智能补全和schema提示
- 保存时自动生成差异对比报告
- 缓存更新采用pub/sub模式通知集群节点

### 2.3 API服务调用流程
```mermaid
graph LR
    A[客户端请求] --> B{认证?}
    B -->|已认证| C[路由分发]
    B -->|未认证| D[返回401]
    C --> E[缓存检查]
    E -->|命中| F[返回缓存数据]
    E -->|未命中| G[DB查询]
    G --> H[填充缓存]
    H --> I[返回数据]
```

**性能保障措施：**
- Redis缓存设置5分钟TTL
- 数据库查询使用读写分离
- 高频接口启用本地缓存

## 3. 状态管理

### 3.1 关键状态机
**应用状态：**
```mermaid
stateDiagram
    [*] --> 草稿
    草稿 --> 已发布: 版本发布
    已发布 --> 已下线: 管理员操作
    已下线 --> 已发布: 重新发布
```

**会员权限状态：**
- 编辑中（自动保存草稿）
- 已生效（通过验证）
- 历史版本（可回滚）

### 3.2 会话管理
- JWT令牌有效期2小时
- 并发会话限制：≤3个设备
- 令牌刷新机制：最后30分钟可续期

## 4. 安全流程

### 4.1 关键操作防护
```mermaid
graph TD
    A[触发删除] --> B[弹出确认框]
    B --> C{管理员确认}
    C -->|是| D[执行删除]
    C -->|否| E[取消操作]
    D --> F[记录审计日志]
```

### 4.2 攻击防护流程
1. 检测到3次连续失败→触发账户锁定
2. 识别SQL注入特征→立即阻断并告警
3. 高频请求(>50次/分)→启用验证码挑战

## 5. 数据同步机制

| 数据类型 | 同步策略 | 延迟控制 |
|----------|----------|----------|
| 版本数据 | 双写MySQL+ES | <1s |
| 权限配置 | Redis发布订阅 | <500ms |
| 审计日志 | 异步队列处理 | <5s |

## 6. 异常处理流程

### 6.1 错误代码映射
| 场景 | HTTP状态码 | 处理建议 |
|------|------------|----------|
| 无效应用ID | 404 | 检查ID是否存在 |
| JSON格式错误 | 400 | 使用格式化工具 |
| 权限不足 | 403 | 联系管理员 |
| 系统过载 | 503 | 指数退避重试 |

### 6.2 监控告警
- 错误率>1%触发企业微信通知
- 响应时间>1s记录性能日志
- 每日生成错误统计报告

## 7. 整体架构流程图
```mermaid
graph TB
    subgraph 客户端
        A[Web管理台]
        B[移动APP]
        C[第三方集成]
    end

    subgraph 服务层
        D[API网关]
        E[应用服务]
        F[会员服务]
    end

    subgraph 数据层
        G[MySQL]
        H[Redis]
        I[Elasticsearch]
    end

    A --> D
    B --> D
    C --> D
    D --> E
    D --> F
    E --> G
    E --> H
    F --> G
    F --> H
    E --> I
```

**流程文档版本控制：**
- 初始版本：v1.0.0
- 最后更新：2023-12-20
- 适用版本：系统v1.0及以上